<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Belajar Yuk! 🎓 - Battle Mode</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    
    <!-- Firebase SDK v9+ (Modular) -->
    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getDatabase, ref, set, get, onValue, update, remove, push, child } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js';
        
        // Firebase Configuration
        const firebaseConfig = {
            apiKey: "AIzaSyAJMQZiUxlIvBMBABqVpbsi1Axz0ASGI48",
            authDomain: "belajar-yuk-battle.firebaseapp.com",
            databaseURL: "https://belajar-yuk-battle-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "belajar-yuk-battle",
            storageBucket: "belajar-yuk-battle.firebasestorage.app",
            messagingSenderId: "262156840353",
            appId: "1:262156840353:web:a99f5e1132383c70ad6fe0",
            measurementId: "G-3FFYJKEW8C"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const database = getDatabase(app);
        
        // Make Firebase functions available globally
        window.firebaseDB = database;
        window.firebaseRef = ref;
        window.firebaseSet = set;
        window.firebaseGet = get;
        window.firebaseOnValue = onValue;
        window.firebaseUpdate = update;
        window.firebaseRemove = remove;
        window.firebasePush = push;
        window.firebaseChild = child;
        
        console.log('🔥 Firebase initialized successfully!');
    </script>
    
    <style>
        body {
            background: url('child.png') no-repeat center center fixed;
            background-size: cover;
            min-height: 100vh;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', 'Helvetica Neue', Arial, sans-serif;
            font-weight: 600;
            position: relative;
        }
        
        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255, 255, 255, 0.1);
            z-index: -1;
        }
        
        .main-container {
            max-width: 900px;
            margin: 0 auto;
            padding: 20px;
        }
        
        .menu-card, .game-card {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            padding: 30px;
            margin: 20px 0;
            text-align: center;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        
        .menu-btn {
            width: 100%;
            height: 80px;
            border: none;
            border-radius: 15px;
            font-size: 1.2rem;
            font-weight: bold;
            margin: 10px 0;
            transition: transform 0.2s;
            color: white;
        }
        
        .menu-btn:hover {
            transform: scale(1.05);
        }
        
        .btn-reading { background: linear-gradient(45deg, #ff6b6b, #ff8e53); }
        .btn-math { background: linear-gradient(45deg, #4ecdc4, #44a08d); }
        .btn-guess { background: linear-gradient(45deg, #45b7d1, #96c93d); }
        .btn-sequence { background: linear-gradient(45deg, #f093fb, #f5576c); }
        .btn-battle { background: linear-gradient(45deg, #FF6B6B, #FFD93D, #6BCF7F); }
        
        .alphabet-container {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 20px;
            margin: 20px 0;
        }
        
        .alphabet-display {
            font-size: 4rem;
            color: #ff6b6b;
            font-weight: bold;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.1);
        }
        
        .alphabet-lowercase {
            font-size: 3rem;
            color: #4ecdc4;
            font-weight: bold;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.1);
        }
        
        .syllable-display {
            font-size: 2rem;
            color: #4ecdc4;
            margin: 10px 0;
        }
        
        .math-problem {
            font-size: 1.8rem;
            color: #333;
            margin: 20px 0;
        }
        
        .math-visual {
            display: flex;
            justify-content: center;
            align-items: center;
            flex-wrap: wrap;
            margin: 20px 0;
        }
        
        .math-item {
            font-size: 2rem;
            margin: 5px;
            padding: 10px;
            background: #f8f9fa;
            border-radius: 10px;
        }
        
        .answer-input {
            font-size: 2rem;
            text-align: center;
            border: 3px solid #4ecdc4;
            border-radius: 15px;
            padding: 10px;
            width: 100px;
        }
        
        .image-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
            margin: 20px 0;
        }
        
        .image-item {
            border: 3px solid transparent;
            border-radius: 10px;
            cursor: pointer;
            transition: border-color 0.2s;
            padding: 10px;
            background: #f8f9fa;
            min-height: 80px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
        }
        
        .image-item:hover {
            border-color: #45b7d1;
        }
        
        .image-item.selected {
            border-color: #28a745;
            background: #d4edda;
        }
        
        .sequence-display {
            font-size: 2rem;
            color: #f5576c;
            margin: 20px 0;
            font-weight: bold;
        }
        
        .control-buttons {
            position: fixed;
            bottom: 20px;
            right: 20px;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        
        .control-btn {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            border: none;
            font-size: 1.2rem;
            color: white;
            box-shadow: 0 4px 10px rgba(0,0,0,0.2);
        }
        
        .btn-random { background: #ff6b6b; }
        .btn-back { background: #6c757d; }
        
        .hidden { display: none; }
        
        .result-message {
            font-size: 1.5rem;
            font-weight: bold;
            margin: 20px 0;
            padding: 15px;
            border-radius: 10px;
        }
        
        .correct { background: #d4edda; color: #155724; }
        .incorrect { background: #f8d7da; color: #721c24; }
        
        .login-notes {
            margin-top: 20px;
        }
        
        .notes-box {
            background: white;
            border-radius: 15px;
            padding: 15px;
            border: 2px solid #e9ecef;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .notes-text {
            font-size: 0.9rem;
            color: #6c757d;
            margin: 0;
            line-height: 1.5;
            text-align: center;
        }

        /* Battle Mode Styles */
        .room-code {
            font-size: 2.5rem;
            font-weight: bold;
            color: #ff6b6b;
            background: #fff3cd;
            padding: 15px;
            border-radius: 15px;
            margin: 20px 0;
            letter-spacing: 5px;
        }

        .player-list {
            max-height: 300px;
            overflow-y: auto;
            margin: 20px 0;
        }

        .player-item {
            background: #f8f9fa;
            padding: 15px;
            margin: 5px 0;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .player-item.admin {
            background: #fff3cd;
            border: 2px solid #ffc107;
        }

        .question-container {
            background: white;
            padding: 25px;
            border-radius: 15px;
            margin: 20px 0;
            box-shadow: 0 4px 10px rgba(0,0,0,0.1);
        }

        .question-text {
            font-size: 1.3rem;
            color: #333;
            margin-bottom: 20px;
            font-weight: 600;
        }

        .answer-option {
            background: #f8f9fa;
            border: 3px solid transparent;
            padding: 15px;
            margin: 10px 0;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.2s;
            text-align: left;
            font-size: 1.1rem;
        }

        .answer-option:hover {
            border-color: #45b7d1;
            transform: translateX(5px);
        }

        .answer-option.selected {
            border-color: #28a745;
            background: #d4edda;
        }

        .answer-option.correct {
            border-color: #28a745;
            background: #d4edda;
        }

        .answer-option.wrong {
            border-color: #dc3545;
            background: #f8d7da;
        }

        .timer-bar {
            height: 40px;
            background: #e9ecef;
            border-radius: 20px;
            overflow: hidden;
            position: relative;
            margin: 20px 0;
        }

        .timer-fill {
            height: 100%;
            background: linear-gradient(90deg, #28a745, #ffc107, #dc3545);
            transition: width 0.1s linear;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            font-size: 1.2rem;
        }

        .score-display {
            font-size: 1.5rem;
            font-weight: bold;
            color: #ff6b6b;
            margin: 10px 0;
        }

        .podium {
            display: flex;
            justify-content: center;
            align-items: flex-end;
            gap: 20px;
            margin: 40px 0;
            min-height: 300px;
        }

        .podium-place {
            background: white;
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.2);
            text-align: center;
            min-width: 150px;
        }

        .podium-place.first {
            order: 2;
            height: 250px;
            background: linear-gradient(135deg, #FFD700, #FFA500);
            margin-bottom: 50px;
        }

        .podium-place.second {
            order: 1;
            height: 200px;
            background: linear-gradient(135deg, #C0C0C0, #808080);
        }

        .podium-place.third {
            order: 3;
            height: 150px;
            background: linear-gradient(135deg, #CD7F32, #8B4513);
        }

        .podium-rank {
            font-size: 3rem;
            font-weight: bold;
            margin-bottom: 10px;
        }

        .podium-name {
            font-size: 1.2rem;
            font-weight: bold;
            margin: 10px 0;
        }

        .podium-score {
            font-size: 1.5rem;
            font-weight: bold;
        }

        .leaderboard {
            background: white;
            padding: 20px;
            border-radius: 15px;
            margin: 20px 0;
        }

        .leaderboard-item {
            display: flex;
            justify-content: space-between;
            padding: 10px;
            border-bottom: 1px solid #e9ecef;
        }

        .difficulty-badge {
            display: inline-block;
            padding: 5px 10px;
            border-radius: 5px;
            font-size: 0.8rem;
            font-weight: bold;
            margin-left: 10px;
        }

        .difficulty-easy { background: #d4edda; color: #155724; }
        .difficulty-medium { background: #fff3cd; color: #856404; }
        .difficulty-hard { background: #f8d7da; color: #721c24; }

        .question-number {
            font-size: 1.1rem;
            color: #6c757d;
            margin-bottom: 10px;
        }

        .waiting-players {
            font-size: 1.2rem;
            color: #6c757d;
            margin: 20px 0;
        }
    </style>
</head>
<body>
    <div class="main-container">
        <!-- Login Screen -->
        <div id="loginScreen" class="menu-card">
            <h1 class="text-center mb-4">🎓 Selamat Datang!</h1>
            <div class="mb-3">
                <label for="usernameInput" class="form-label">Siapa nama kamu?</label>
                <input type="text" class="form-control" id="usernameInput" placeholder="Tulis nama kamu di sini..." 
                       style="font-size: 1.2rem; padding: 15px; border-radius: 15px; border: 3px solid #4ecdc4;">
            </div>
            <button class="btn btn-success btn-lg" onclick="login()" style="width: 100%; padding: 15px; font-size: 1.2rem; border-radius: 15px;">
                <i class="fas fa-play"></i> Mulai Belajar!
            </button>
            
            <div class="login-notes mt-4">
                <div class="notes-box">
                    <p class="notes-text">
                        📝 Soal di dalam apps ini dikhususkan untuk anak di bawah 6 tahun<br>
                        👨‍👩‍👧‍👦 Ayah & Bunda harus memantau anak dalam belajar!<br>
                        ⚔️ Mode Battle: Adu cepat & pintar dengan teman!<br>
                        @<strong>Update Version 2.0</strong>
                    </p>
                </div>
            </div>
        </div>

        <!-- Menu Utama -->
        <div id="mainMenu" class="menu-card hidden">
            <h1 class="text-center mb-4">🎓 Hai <span id="displayUsername">Adik</span>! Belajar Yuk!</h1>
            <button class="menu-btn btn-reading" onclick="startReading()">
                <i class="fas fa-book"></i> Membaca
            </button>
            <button class="menu-btn btn-math" onclick="startMath()">
                <i class="fas fa-calculator"></i> Berhitung
            </button>
            <button class="menu-btn btn-guess" onclick="startGuessing()">
                <i class="fas fa-eye"></i> Menebak
            </button>
            <button class="menu-btn btn-sequence" onclick="startSequence()">
                <i class="fas fa-sort-numeric-up"></i> Urutan
            </button>
            <button class="menu-btn btn-battle" onclick="showBattleMenu()">
                <i class="fas fa-trophy"></i> Mode Battle
            </button>
        </div>

        <!-- Battle Menu -->
        <div id="battleMenu" class="menu-card hidden">
            <h2 class="text-center mb-4">⚔️ Mode Battle</h2>
            <p class="text-center">Adu cepat dan pintar dengan temanmu!</p>
            
            <button class="btn btn-primary btn-lg mb-3" onclick="createRoom()" style="width: 100%; padding: 15px; border-radius: 15px;">
                <i class="fas fa-plus"></i> Buat Room Baru
            </button>
            
            <div class="mt-4">
                <label for="roomCodeInput" class="form-label">Atau Masuk ke Room:</label>
                <div class="input-group">
                    <input type="text" class="form-control form-control-lg" id="roomCodeInput" 
                           placeholder="Masukkan kode room..." style="border-radius: 15px 0 0 15px;">
                    <button class="btn btn-success" onclick="joinRoom()" style="border-radius: 0 15px 15px 0;">
                        <i class="fas fa-sign-in-alt"></i> Gabung
                    </button>
                </div>
            </div>
        </div>

        <!-- Battle Room Waiting -->
        <div id="battleWaiting" class="game-card hidden">
            <h2 class="text-center">⚔️ Ruang Tunggu</h2>
            <div class="room-code" id="displayRoomCode">XXXX</div>
            <p class="text-center">Bagikan kode ini ke temanmu!</p>
            
            <div class="mb-4">
                <label for="questionCountSelect" class="form-label">Jumlah Soal:</label>
                <select class="form-select form-select-lg" id="questionCountSelect" 
                        style="border-radius: 15px; border: 3px solid #4ecdc4;">
                    <option value="10">10 Soal</option>
                    <option value="15">15 Soal</option>
                    <option value="20">20 Soal</option>
                </select>
            </div>
            
            <div class="waiting-players">
                <i class="fas fa-users"></i> <span id="playerCount">1</span>/15 Pemain
            </div>
            
            <div class="player-list" id="playerList">
                <!-- Players will be added here -->
            </div>
            
            <button class="btn btn-success btn-lg mt-3" id="startBattleBtn" onclick="startBattle()" 
                    style="width: 100%; padding: 15px; border-radius: 15px;" disabled>
                <i class="fas fa-play"></i> Mulai Battle!
            </button>
            
            <p class="text-muted mt-2" style="font-size: 0.9rem;">
                * Minimal 2 pemain untuk memulai
            </p>
        </div>

        <!-- Battle Game -->
        <div id="battleGame" class="game-card hidden">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <div class="question-number">
                    Soal <span id="currentQuestionNum">1</span>/<span id="totalQuestions">10</span>
                </div>
                <div class="score-display">
                    <i class="fas fa-star"></i> Score: <span id="playerScore">0</span>
                </div>
            </div>
            
            <div class="timer-bar">
                <div class="timer-fill" id="timerFill" style="width: 100%;">
                    <i class="fas fa-clock"></i> <span id="timerText">7</span>s
                </div>
            </div>
            
            <div class="question-container">
                <div class="question-text" id="battleQuestion">
                    Pertanyaan akan muncul di sini...
                </div>
                
                <div id="battleOptions">
                    <div class="answer-option" onclick="selectAnswer(this, 'A')">
                        <strong>A.</strong> <span id="optionA">Pilihan A</span>
                    </div>
                    <div class="answer-option" onclick="selectAnswer(this, 'B')">
                        <strong>B.</strong> <span id="optionB">Pilihan B</span>
                    </div>
                    <div class="answer-option" onclick="selectAnswer(this, 'C')">
                        <strong>C.</strong> <span id="optionC">Pilihan C</span>
                    </div>
                    <div class="answer-option" onclick="selectAnswer(this, 'D')">
                        <strong>D.</strong> <span id="optionD">Pilihan D</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Battle Results -->
        <div id="battleResults" class="game-card hidden">
            <h2 class="text-center mb-4">🏆 Hasil Battle</h2>
            
            <div class="podium" id="podium">
                <!-- Top 3 will be displayed here -->
            </div>
            
            <div class="leaderboard">
                <h4 class="text-center mb-3">📊 Leaderboard Lengkap</h4>
                <div id="fullLeaderboard">
                    <!-- All players will be listed here -->
                </div>
            </div>
            
            <button class="btn btn-success btn-lg mt-3" onclick="resetRoom()" 
                    style="width: 100%; padding: 15px; border-radius: 15px;">
                <i class="fas fa-redo"></i> Main Lagi
            </button>
        </div>

        <!-- Original Games (Reading, Math, Guess, Sequence) -->
        <div id="readingGame" class="game-card hidden">
            <h2 class="text-center">📖 Belajar Membaca</h2>
            <div class="alphabet-container">
                <div class="alphabet-display" id="alphabetDisplay">A</div>
                <div class="alphabet-lowercase" id="alphabetLowercase">a</div>
            </div>
            <div class="syllable-display" id="syllableDisplay">A - a</div>
            <div class="text-center">
                <p id="readingExample">Contoh: <strong>Apel</strong></p>
            </div>
        </div>

        <div id="mathGame" class="game-card hidden">
            <h2 class="text-center">🔢 Berhitung</h2>
            <div class="text-center mb-3">
                <button class="btn btn-warning me-2" id="easyModeBtn" onclick="setMathMode('easy')">
                    <i class="fas fa-child"></i> Mudah
                </button>
                <button class="btn btn-danger" id="hardModeBtn" onclick="setMathMode('hard')">
                    <i class="fas fa-brain"></i> Sulit
                </button>
            </div>
            <div class="math-problem" id="mathProblem">5 mobil + 2 mobil = ?</div>
            <div class="math-visual" id="mathVisual"></div>
            <button class="btn btn-success btn-lg mt-3" onclick="checkMathAnswer()">
                <i class="fas fa-check"></i> Periksa
            </button>
            <div id="mathResult" class="result-message hidden"></div>
        </div>

        <div id="guessGame" class="game-card hidden">
            <h2 class="text-center">👁️ Tebak Gambar</h2>
            <p class="text-center">Pilih semua gambar <strong id="guessTarget">mobil</strong>!</p>
            <div class="image-grid" id="imageGrid"></div>
            <button class="btn btn-success btn-lg mt-3" onclick="checkGuessAnswer()">
                <i class="fas fa-check"></i> Periksa
            </button>
            <div id="guessResult" class="result-message hidden"></div>
        </div>

        <div id="sequenceGame" class="game-card hidden">
            <h2 class="text-center">🔢 Urutan Angka</h2>
            <p class="text-center">Pilih urutan yang benar:</p>
            <div class="sequence-display" id="sequenceQuestion">Mana yang benar?</div>
            <div class="d-grid gap-2">
                <button class="btn btn-outline-primary btn-lg" onclick="selectSequence(this, 'A')">
                    A. <span id="seqOptionA">12345</span>
                </button>
                <button class="btn btn-outline-primary btn-lg" onclick="selectSequence(this, 'B')">
                    B. <span id="seqOptionB">65874</span>
                </button>
            </div>
            <div id="sequenceResult" class="result-message hidden"></div>
        </div>
    </div>

    <!-- Control Buttons -->
    <div class="control-buttons" id="controlButtons">
        <button class="control-btn btn-random" onclick="randomizeQuestion()" title="Acak Soal">
            <i class="fas fa-random"></i>
        </button>
        <button class="control-btn btn-back" onclick="goBack()" title="Kembali">
            <i class="fas fa-arrow-left"></i>
        </button>
    </div>

    <script>
        // Original game variables
        let currentGame = '';
        let currentMathAnswer = 0;
        let currentGuessTarget = '';
        let selectedImages = [];
        let correctSequence = '';
        let mathMode = 'hard';
        let currentReadingIndex = 0;
        let username = '';

        // Battle mode variables
        let roomCode = '';
        let isAdmin = false;
        let players = [];
        let battleQuestions = [];
        let currentQuestionIndex = 0;
        let playerScore = 0;
        let timeLeft = 7;
        let timerInterval = null;
        let selectedAnswer = null;
        let questionCount = 10;
        let playerId = '';
        let syncInterval = null;
        let roomListener = null;
        let questionTimerInterval = null;
        let currentQuestionStartTime = 0;

        // API Configuration - QuizAPI.io
        const QUIZ_API_URL = 'https://quizapi.io/api/v1/questions';
        const QUIZ_API_KEY = 'YOUR_API_KEY_HERE'; // User perlu ganti dengan API key mereka

        // Fetch questions from QuizAPI
        async function fetchTriviaQuestions(count) {
            try {
                // QuizAPI params
                const params = new URLSearchParams({
                    apiKey: QUIZ_API_KEY,
                    limit: count,
                    difficulty: 'Easy,Medium,Hard' // Mix difficulties
                });
                
                const response = await fetch(`${QUIZ_API_URL}?${params}`);
                
                if (!response.ok) {
                    throw new Error(`API Error: ${response.status}`);
                }
                
                const data = await response.json();
                
                if (!data || data.length === 0) {
                    throw new Error('No questions returned from API');
                }
                
                // Transform QuizAPI data to our format
                return data.map((q) => {
                    const answers = q.answers;
                    const correctAnswers = q.correct_answers;
                    
                    // Get all non-null answers
                    const options = [];
                    const correctKey = [];
                    
                    Object.keys(answers).forEach(key => {
                        if (answers[key] !== null) {
                            options.push(answers[key]);
                            // Check if this is correct answer
                            const correctKey_name = key + '_correct';
                            if (correctAnswers[correctKey_name] === 'true') {
                                correctKey.push(options.length - 1);
                            }
                        }
                    });
                    
                    // Ensure we have exactly 4 options
                    while (options.length < 4) {
                        options.push('N/A');
                    }
                    
                    // Get correct answer letter (A, B, C, D)
                    const correctLetter = ['A', 'B', 'C', 'D'][correctKey[0] || 0];
                    
                    // Determine weight based on difficulty
                    const difficulty = q.difficulty ? q.difficulty.toLowerCase() : 'medium';
                    const weight = difficulty === 'easy' ? 5 : difficulty === 'hard' ? 15 : 10;
                    
                    return {
                        category: q.category || 'General',
                        difficulty: difficulty,
                        weight: weight,
                        question: q.question,
                        options: options.slice(0, 4),
                        correct: correctLetter
                    };
                });
            } catch (error) {
                console.error('Error fetching quiz questions:', error);
                alert('Gagal mengambil soal dari QuizAPI!\n\nPastikan:\n1. API Key sudah diisi\n2. Koneksi internet aktif\n3. Quota API masih tersedia (100/hari gratis)');
                return [];
            }
        }

        // Firebase Helper Functions
        function saveRoomToFirebase(room) {
            const roomRef = window.firebaseRef(window.firebaseDB, 'rooms/' + roomCode);
            window.firebaseSet(roomRef, room);
        }

        function updateRoomField(field, value) {
            const roomRef = window.firebaseRef(window.firebaseDB, 'rooms/' + roomCode + '/' + field);
            window.firebaseSet(roomRef, value);
        }

        function getRoomFromFirebase(callback) {
            const roomRef = window.firebaseRef(window.firebaseDB, 'rooms/' + roomCode);
            window.firebaseGet(roomRef).then((snapshot) => {
                if (snapshot.exists()) {
                    callback(snapshot.val());
                } else {
                    callback(null);
                }
            });
        }

        function listenToRoom() {
            if (roomListener) return;
            
            const roomRef = window.firebaseRef(window.firebaseDB, 'rooms/' + roomCode);
            roomListener = window.firebaseOnValue(roomRef, (snapshot) => {
                if (snapshot.exists()) {
                    const room = snapshot.val();
                    players = room.players || [];
                    updatePlayerList();
                    
                    // Check if game started
                    if (room.gameStarted && !room.gameEnded) {
                        if (document.getElementById('battleWaiting').classList.contains('hidden') === false) {
                            questionCount = room.questionCount || 10;
                            battleQuestions = room.questions || [];
                            startBattleForAll();
                        }
                        
                        // Sync current question
                        if (room.currentQuestion !== undefined && room.currentQuestion !== currentQuestionIndex) {
                            currentQuestionIndex = room.currentQuestion;
                            currentQuestionStartTime = room.questionStartTime || Date.now();
                            loadBattleQuestion();
                        }
                    }
                    
                    // Check if game ended - sync podium data
                    if (room.gameEnded) {
                        const battleGame = document.getElementById('battleGame');
                        const battleResults = document.getElementById('battleResults');
                        
                        if (!battleGame.classList.contains('hidden')) {
                            // Still in game, move to results
                            players = room.players.sort((a, b) => b.score - a.score);
                            endBattleForAll();
                        } else if (!battleResults.classList.contains('hidden')) {
                            // Already in results, just update leaderboard
                            players = room.players.sort((a, b) => b.score - a.score);
                            displayResults();
                        }
                    }
                }
            });
        }

        function stopListeningToRoom() {
            if (roomListener) {
                roomListener = null;
            }
        }

        // Battle Questions Database (Soal CPNS style)
        const battleQuestionsDB = [
            // Matematika
            {
                category: 'math',
                difficulty: 'medium',
                weight: 10,
                question: 'Jika 3x + 5 = 20, maka nilai x adalah?',
                options: ['3', '5', '7', '10'],
                correct: 'B'
            },
            {
                category: 'math',
                difficulty: 'hard',
                weight: 15,
                question: 'Sebuah kereta api berangkat dari Jakarta ke Bandung dengan kecepatan 80 km/jam. Jika jarak Jakarta-Bandung 160 km, berapa lama perjalanan?',
                options: ['1 jam', '2 jam', '3 jam', '4 jam'],
                correct: 'B'
            },
            {
                category: 'math',
                difficulty: 'medium',
                weight: 10,
                question: 'Hasil dari 15% dari 200 adalah?',
                options: ['20', '25', '30', '35'],
                correct: 'C'
            },
            {
                category: 'math',
                difficulty: 'hard',
                weight: 15,
                question: 'Jika A = 2, B = 3, maka (A² + B²) × 2 = ?',
                options: ['20', '22', '24', '26'],
                correct: 'D'
            },
            {
                category: 'math',
                difficulty: 'easy',
                weight: 5,
                question: '25 + 37 = ?',
                options: ['52', '62', '72', '82'],
                correct: 'B'
            },
            {
                category: 'math',
                difficulty: 'medium',
                weight: 10,
                question: 'Sebuah toko memberikan diskon 20%. Jika harga awal Rp 100.000, berapakah harga setelah diskon?',
                options: ['Rp 70.000', 'Rp 75.000', 'Rp 80.000', 'Rp 85.000'],
                correct: 'C'
            },
            {
                category: 'math',
                difficulty: 'hard',
                weight: 15,
                question: 'Deret angka: 2, 6, 12, 20, 30, ... Angka selanjutnya adalah?',
                options: ['38', '40', '42', '44'],
                correct: 'C'
            },
            {
                category: 'math',
                difficulty: 'medium',
                weight: 10,
                question: 'Jika 1 lusin = 12, berapa buah dalam 3,5 lusin?',
                options: ['36', '40', '42', '48'],
                correct: 'C'
            },
            // Bahasa Indonesia
            {
                category: 'indonesian',
                difficulty: 'medium',
                weight: 10,
                question: 'Kata baku yang benar adalah?',
                options: ['aktifitas', 'aktivitas', 'aktifitasi', 'aktivitasi'],
                correct: 'B'
            },
            {
                category: 'indonesian',
                difficulty: 'hard',
                weight: 15,
                question: 'Kalimat yang menggunakan kata "di" dengan benar adalah?',
                options: ['Dia duduk dikursi', 'Dia duduk di kursi', 'Diaduduk dikursi', 'Di aduduk di kursi'],
                correct: 'B'
            },
            {
                category: 'indonesian',
                difficulty: 'medium',
                weight: 10,
                question: 'Makna peribahasa "Air susu dibalas dengan air tua" adalah?',
                options: ['Kebaikan dibalas kejahatan', 'Berbuat baik', 'Memberi hadiah', 'Membalas dendam'],
                correct: 'A'
            },
            // Bahasa Inggris
            {
                category: 'english',
                difficulty: 'easy',
                weight: 5,
                question: 'What is the opposite of "hot"?',
                options: ['warm', 'cold', 'cool', 'freeze'],
                correct: 'B'
            },
            {
                category: 'english',
                difficulty: 'medium',
                weight: 10,
                question: 'Choose the correct sentence:',
                options: ['She go to school', 'She goes to school', 'She going to school', 'She gone to school'],
                correct: 'B'
            },
            {
                category: 'english',
                difficulty: 'hard',
                weight: 15,
                question: 'What is the past tense of "write"?',
                options: ['writed', 'wrote', 'written', 'writing'],
                correct: 'B'
            },
            {
                category: 'english',
                difficulty: 'medium',
                weight: 10,
                question: '"Beautiful" is a/an...',
                options: ['noun', 'verb', 'adjective', 'adverb'],
                correct: 'C'
            },
            {
                category: 'english',
                difficulty: 'hard',
                weight: 15,
                question: 'Which sentence is grammatically correct?',
                options: ['If I was rich, I buy a car', 'If I were rich, I would buy a car', 'If I am rich, I will bought a car', 'If I be rich, I buying a car'],
                correct: 'B'
            },
            {
                category: 'english',
                difficulty: 'easy',
                weight: 5,
                question: 'The color of the sky is...',
                options: ['red', 'blue', 'green', 'yellow'],
                correct: 'B'
            },
            {
                category: 'english',
                difficulty: 'medium',
                weight: 10,
                question: 'What is the synonym of "happy"?',
                options: ['sad', 'angry', 'joyful', 'tired'],
                correct: 'C'
            },
            // Logika
            {
                category: 'logic',
                difficulty: 'medium',
                weight: 10,
                question: 'Jika semua A adalah B, dan semua B adalah C, maka?',
                options: ['Semua A adalah C', 'Semua C adalah A', 'Tidak ada A yang C', 'Tidak dapat ditentukan'],
                correct: 'A'
            },
            {
                category: 'logic',
                difficulty: 'hard',
                weight: 15,
                question: 'Pola: ○ △ ○ △ ○ ... Bentuk selanjutnya?',
                options: ['○', '△', '□', '◇'],
                correct: 'B'
            },
            {
                category: 'logic',
                difficulty: 'medium',
                weight: 10,
                question: 'Jika hari ini Senin, 10 hari lagi adalah hari?',
                options: ['Senin', 'Kamis', 'Jumat', 'Sabtu'],
                correct: 'B'
            },
            {
                category: 'logic',
                difficulty: 'hard',
                weight: 15,
                question: 'Deret: Z, Y, X, W, ... Huruf selanjutnya?',
                options: ['U', 'V', 'T', 'S'],
                correct: 'B'
            },
            {
                category: 'math',
                difficulty: 'easy',
                weight: 5,
                question: '7 × 8 = ?',
                options: ['54', '56', '58', '60'],
                correct: 'B'
            },
            {
                category: 'math',
                difficulty: 'medium',
                weight: 10,
                question: 'Luas persegi dengan sisi 5 cm adalah?',
                options: ['20 cm²', '25 cm²', '30 cm²', '35 cm²'],
                correct: 'B'
            },
            {
                category: 'indonesian',
                difficulty: 'easy',
                weight: 5,
                question: 'Huruf kapital digunakan untuk menulis?',
                options: ['Nama hari', 'Kata ganti', 'Kata kerja', 'Kata sifat'],
                correct: 'A'
            },
            {
                category: 'english',
                difficulty: 'easy',
                weight: 5,
                question: 'How many days in a week?',
                options: ['5', '6', '7', '8'],
                correct: 'C'
            }
        ];

        // Original game data
        const readingData = [
            { letter: 'A', lowercase: 'a', syllable: 'A - a', example: 'Apel 🍎' },
            { letter: 'B', lowercase: 'b', syllable: 'Ba - bi - bu', example: 'Bola ⚽' },
            { letter: 'C', lowercase: 'c', syllable: 'Ca - ci - cu', example: 'Cinta ❤️' },
            { letter: 'D', lowercase: 'd', syllable: 'Da - di - du', example: 'Dadu 🎲' },
            { letter: 'E', lowercase: 'e', syllable: 'E - e', example: 'Elang 🦅' },
            { letter: 'F', lowercase: 'f', syllable: 'Fa - fi - fu', example: 'Foto 📷' },
            { letter: 'G', lowercase: 'g', syllable: 'Ga - gi - gu', example: 'Gajah 🐘' },
            { letter: 'H', lowercase: 'h', syllable: 'Ha - hi - hu', example: 'Hari ☀️' },
            { letter: 'I', lowercase: 'i', syllable: 'I - i', example: 'Ikan 🐟' },
            { letter: 'J', lowercase: 'j', syllable: 'Ja - ji - ju', example: 'Jari ☝️' },
            { letter: 'K', lowercase: 'k', syllable: 'Ka - ki - ku', example: 'Kucing 🐱' },
            { letter: 'L', lowercase: 'l', syllable: 'La - li - lu', example: 'Lampu 💡' },
            { letter: 'M', lowercase: 'm', syllable: 'Ma - mi - mu', example: 'Mata 👁️' },
            { letter: 'N', lowercase: 'n', syllable: 'Na - ni - nu', example: 'Nanas 🍍' },
            { letter: 'O', lowercase: 'o', syllable: 'O - o', example: 'Orang 👤' },
            { letter: 'P', lowercase: 'p', syllable: 'Pa - pi - pu', example: 'Pohon 🌳' },
            { letter: 'Q', lowercase: 'q', syllable: 'Qa - qi - qu', example: 'Queen 👸' },
            { letter: 'R', lowercase: 'r', syllable: 'Ra - ri - ru', example: 'Rumah 🏠' },
            { letter: 'S', lowercase: 's', syllable: 'Sa - si - su', example: 'Sapi 🐄' },
            { letter: 'T', lowercase: 't', syllable: 'Ta - ti - tu', example: 'Topi 👒' },
            { letter: 'U', lowercase: 'u', syllable: 'U - u', example: 'Ular 🐍' },
            { letter: 'V', lowercase: 'v', syllable: 'Va - vi - vu', example: 'Vas 🏺' },
            { letter: 'W', lowercase: 'w', syllable: 'Wa - wi - wu', example: 'Wajah 😊' },
            { letter: 'X', lowercase: 'x', syllable: 'Xa - xi - xu', example: 'Xray 🦴' },
            { letter: 'Y', lowercase: 'y', syllable: 'Ya - yi - yu', example: 'Yoyo 🪀' },
            { letter: 'Z', lowercase: 'z', syllable: 'Za - zi - zu', example: 'Zebra 🦓' }
        ];

        const mathProblems = [
            { problem: '5 + 2 = ?', easyProblem: '5 mobil + 2 mobil = ?', visual: ['🚗🚗🚗🚗🚗', '+', '🚗🚗'], numbers: ['5', '+', '2'], answer: 7 },
            { problem: '2 + 7 = ?', easyProblem: '2 sapi + 7 sapi = ?', visual: ['🐄🐄', '+', '🐄🐄🐄🐄🐄🐄🐄'], numbers: ['2', '+', '7'], answer: 9 },
            { problem: '3 + 1 = ?', easyProblem: '3 kucing + 1 kucing = ?', visual: ['🐱🐱🐱', '+', '🐱'], numbers: ['3', '+', '1'], answer: 4 },
            { problem: '6 + 3 = ?', easyProblem: '6 burung + 3 burung = ?', visual: ['🐦🐦🐦🐦🐦🐦', '+', '🐦🐦🐦'], numbers: ['6', '+', '3'], answer: 9 },
            { problem: '4 + 2 = ?', easyProblem: '4 ikan + 2 ikan = ?', visual: ['🐟🐟🐟🐟', '+', '🐟🐟'], numbers: ['4', '+', '2'], answer: 6 }
        ];

        const guessProblems = [
            {
                target: 'mobil',
                items: [
                    { text: '🚗 Mobil', type: 'car', correct: true },
                    { text: '🌳 Pohon', type: 'tree', correct: false },
                    { text: '🚙 Mobil', type: 'car', correct: true },
                    { text: '🏠 Rumah', type: 'house', correct: false }
                ]
            },
            {
                target: 'hewan',
                items: [
                    { text: '🐱 Kucing', type: 'animal', correct: true },
                    { text: '🌺 Bunga', type: 'flower', correct: false },
                    { text: '🐶 Anjing', type: 'animal', correct: true },
                    { text: '🍎 Apel', type: 'fruit', correct: false }
                ]
            }
        ];

        const sequenceProblems = [
            { question: 'Urutan angka dari kecil ke besar:', optionA: '1 2 3 4 5', optionB: '5 4 3 2 1', correct: 'A' },
            { question: 'Urutan angka yang benar:', optionA: '4 2 1 3', optionB: '1 2 3 4', correct: 'B' },
            { question: 'Urutan dari 1 sampai 5:', optionA: '1 3 2 4 5', optionB: '1 2 3 4 5', correct: 'B' },
            { question: 'Urutan menurun dari 5 ke 1:', optionA: '5 4 3 2 1', optionB: '1 2 3 4 5', correct: 'A' },
            { question: 'Urutan naik yang benar:', optionA: '2 1 4 3 5', optionB: '1 2 3 4 5', correct: 'B' },
            { question: 'Urutan dari 6 sampai 10:', optionA: '6 7 8 9 10', optionB: '10 9 8 7 6', correct: 'A' },
            { question: 'Urutan menurun dari 10:', optionA: '10 9 8 7 6', optionB: '6 7 8 9 10', correct: 'A' },
            { question: 'Urutan angka 11-15:', optionA: '15 14 13 12 11', optionB: '11 12 13 14 15', correct: 'B' },
            { question: 'Urutan dari 16 ke 20:', optionA: '16 17 18 19 20', optionB: '20 19 18 17 16', correct: 'A' },
            { question: 'Urutan menurun 20-16:', optionA: '20 19 18 17 16', optionB: '16 17 18 19 20', correct: 'A' },
            { question: 'Urutan angka 1-6:', optionA: '6 5 4 3 2 1', optionB: '1 2 3 4 5 6', correct: 'B' },
            { question: 'Urutan dari 7 sampai 12:', optionA: '7 8 9 10 11 12', optionB: '12 11 10 9 8 7', correct: 'A' },
            { question: 'Urutan menurun 15-10:', optionA: '15 14 13 12 11 10', optionB: '10 11 12 13 14 15', correct: 'A' },
            { question: 'Urutan naik 8-13:', optionA: '13 12 11 10 9 8', optionB: '8 9 10 11 12 13', correct: 'B' },
            { question: 'Urutan angka 3-8:', optionA: '3 4 5 6 7 8', optionB: '8 7 6 5 4 3', correct: 'A' },
            { question: 'Urutan menurun 12-7:', optionA: '12 11 10 9 8 7', optionB: '7 8 9 10 11 12', correct: 'A' },
            { question: 'Urutan dari 14 sampai 18:', optionA: '14 15 16 17 18', optionB: '18 17 16 15 14', correct: 'A' },
            { question: 'Urutan angka 5-10:', optionA: '5 6 7 8 9 10', optionB: '10 9 8 7 6 5', correct: 'A' },
            { question: 'Urutan menurun 20-15:', optionA: '15 16 17 18 19 20', optionB: '20 19 18 17 16 15', correct: 'B' },
            { question: 'Urutan naik 9-14:', optionA: '9 10 11 12 13 14', optionB: '14 13 12 11 10 9', correct: 'A' },
            { question: 'Urutan dari 2 sampai 7:', optionA: '2 3 4 5 6 7', optionB: '7 6 5 4 3 2', correct: 'A' },
            { question: 'Urutan menurun 18-13:', optionA: '18 17 16 15 14 13', optionB: '13 14 15 16 17 18', correct: 'A' },
            { question: 'Urutan angka 10-15:', optionA: '15 14 13 12 11 10', optionB: '10 11 12 13 14 15', correct: 'B' },
            { question: 'Urutan dari 4 sampai 9:', optionA: '4 5 6 7 8 9', optionB: '9 8 7 6 5 4', correct: 'A' },
            { question: 'Urutan menurun 17-12:', optionA: '17 16 15 14 13 12', optionB: '12 13 14 15 16 17', correct: 'A' },
            { question: 'Urutan naik 13-18:', optionA: '18 17 16 15 14 13', optionB: '13 14 15 16 17 18', correct: 'B' },
            { question: 'Urutan dari 1 sampai 10:', optionA: '1 2 3 4 5 6 7 8 9 10', optionB: '10 9 8 7 6 5 4 3 2 1', correct: 'A' },
            { question: 'Urutan menurun 20-11:', optionA: '20 19 18 17 16 15 14 13 12 11', optionB: '11 12 13 14 15 16 17 18 19 20', correct: 'A' },
            { question: 'Urutan angka 5-15:', optionA: '5 6 7 8 9 10 11 12 13 14 15', optionB: '15 14 13 12 11 10 9 8 7 6 5', correct: 'A' },
            { question: 'Urutan dari 10 sampai 20:', optionA: '10 11 12 13 14 15 16 17 18 19 20', optionB: '20 19 18 17 16 15 14 13 12 11 10', correct: 'A' }
        ];

        // Battle Mode Functions
        function generateRoomCode() {
            return Math.random().toString(36).substring(2, 6).toUpperCase();
        }

        function generatePlayerId() {
            return 'player_' + Date.now() + '_' + Math.random().toString(36).substring(2, 9);
        }

        function createRoom() {
            roomCode = generateRoomCode();
            playerId = generatePlayerId();
            isAdmin = true;
            
            const room = {
                code: roomCode,
                players: [{ 
                    id: playerId,
                    name: username, 
                    score: 0, 
                    isAdmin: true 
                }],
                createdAt: Date.now(),
                gameStarted: false,
                gameEnded: false,
                questionCount: 10,
                questions: []
            };
            
            saveRoomToFirebase(room);
            players = room.players;
            
            document.getElementById('battleMenu').classList.add('hidden');
            document.getElementById('battleWaiting').classList.remove('hidden');
            document.getElementById('displayRoomCode').textContent = roomCode;
            
            updatePlayerList();
            
            // Start listening to room changes
            listenToRoom();
            
            // Admin can change settings
            document.getElementById('questionCountSelect').disabled = false;
        }

        function joinRoom() {
            const code = document.getElementById('roomCodeInput').value.trim().toUpperCase();
            
            if (code.length !== 4) {
                alert('Kode room harus 4 karakter!');
                return;
            }
            
            roomCode = code;
            playerId = generatePlayerId();
            
            getRoomFromFirebase((room) => {
                if (!room) {
                    alert('Room tidak ditemukan! Pastikan kode benar.');
                    return;
                }
                
                if (room.players.length >= 15) {
                    alert('Room sudah penuh! (Maksimal 15 pemain)');
                    return;
                }
                
                if (room.gameStarted) {
                    alert('Game sudah dimulai! Tidak bisa join.');
                    return;
                }
                
                isAdmin = false;
                
                // Add player to room
                room.players.push({ 
                    id: playerId,
                    name: username, 
                    score: 0, 
                    isAdmin: false 
                });
                
                saveRoomToFirebase(room);
                players = room.players;
                
                document.getElementById('battleMenu').classList.add('hidden');
                document.getElementById('battleWaiting').classList.remove('hidden');
                document.getElementById('displayRoomCode').textContent = roomCode;
                
                // Non-admin cannot change settings
                document.getElementById('questionCountSelect').disabled = true;
                
                updatePlayerList();
                
                // Start listening to room changes
                listenToRoom();
            });
        }

        function updatePlayerList() {
            const playerListDiv = document.getElementById('playerList');
            playerListDiv.innerHTML = '';
            
            players.forEach((player, index) => {
                const playerDiv = document.createElement('div');
                playerDiv.className = player.isAdmin ? 'player-item admin' : 'player-item';
                playerDiv.innerHTML = `
                    <span><i class="fas fa-user"></i> ${player.name} ${player.isAdmin ? '👑' : ''}</span>
                    <span>${index + 1}</span>
                `;
                playerListDiv.appendChild(playerDiv);
            });
            
            document.getElementById('playerCount').textContent = players.length;
            
            // Enable start button if admin and at least 2 players
            if (isAdmin && players.length >= 2) {
                document.getElementById('startBattleBtn').disabled = false;
            }
        }

        function startBattle() {
            if (!isAdmin) {
                alert('Hanya admin yang bisa memulai game!');
                return;
            }
            
            // Show loading
            const startBtn = document.getElementById('startBattleBtn');
            startBtn.disabled = true;
            startBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Memuat soal...';
            
            questionCount = parseInt(document.getElementById('questionCountSelect').value);
            
            // Fetch questions from API
            fetchTriviaQuestions(questionCount).then(questions => {
                if (questions.length === 0) {
                    startBtn.disabled = false;
                    startBtn.innerHTML = '<i class="fas fa-play"></i> Mulai Battle!';
                    return;
                }
                
                battleQuestions = questions;
                
                // Update room with game started status
                getRoomFromFirebase((room) => {
                    if (room) {
                        room.gameStarted = true;
                        room.gameEnded = false;
                        room.questionCount = questionCount;
                        room.questions = battleQuestions;
                        room.currentQuestion = 0;
                        room.questionStartTime = Date.now();
                        saveRoomToFirebase(room);
                    }
                });
                
                startBattleForAll();
            });
        }

        function startBattleForAll() {
            currentQuestionIndex = 0;
            playerScore = 0;
            
            document.getElementById('battleWaiting').classList.add('hidden');
            document.getElementById('battleGame').classList.remove('hidden');
            document.getElementById('totalQuestions').textContent = questionCount;
            
            loadBattleQuestion();
        }

        function loadBattleQuestion() {
            if (currentQuestionIndex >= battleQuestions.length) {
                endBattle();
                return;
            }
            
            const question = battleQuestions[currentQuestionIndex];
            
            document.getElementById('currentQuestionNum').textContent = currentQuestionIndex + 1;
            document.getElementById('battleQuestion').innerHTML = `
                ${question.question}
                <span class="difficulty-badge difficulty-${question.difficulty}">
                    ${question.difficulty === 'easy' ? 'Easy' : question.difficulty === 'medium' ? 'Medium' : 'Hard'} 
                    (+${question.weight} points)
                </span>
            `;
            
            document.getElementById('optionA').textContent = question.options[0] || 'N/A';
            document.getElementById('optionB').textContent = question.options[1] || 'N/A';
            document.getElementById('optionC').textContent = question.options[2] || 'N/A';
            document.getElementById('optionD').textContent = question.options[3] || 'N/A';
            
            // Reset options
            document.querySelectorAll('.answer-option').forEach(opt => {
                opt.className = 'answer-option';
                opt.style.pointerEvents = 'auto';
            });
            
            selectedAnswer = null;
            timeLeft = 7;
            
            // Sync start time from Firebase or set new
            if (!currentQuestionStartTime) {
                currentQuestionStartTime = Date.now();
            }
            
            startSyncTimer();
        }

        function startSyncTimer() {
            clearInterval(questionTimerInterval);
            
            questionTimerInterval = setInterval(() => {
                const elapsed = Math.floor((Date.now() - currentQuestionStartTime) / 1000);
                timeLeft = Math.max(0, 7 - elapsed);
                
                document.getElementById('timerText').textContent = timeLeft;
                const percentage = (timeLeft / 7) * 100;
                document.getElementById('timerFill').style.width = percentage + '%';
                
                if (timeLeft <= 0) {
                    clearInterval(questionTimerInterval);
                    
                    // Disable all options
                    document.querySelectorAll('.answer-option').forEach(opt => {
                        opt.style.pointerEvents = 'none';
                    });
                    
                    // Only admin moves to next question
                    if (isAdmin) {
                        setTimeout(() => {
                            moveToNextQuestion();
                        }, 2000);
                    }
                }
            }, 100);
        }

        function selectAnswer(element, answer) {
            if (timeLeft <= 0) return;
            
            // Remove previous selection
            document.querySelectorAll('.answer-option').forEach(opt => {
                opt.classList.remove('selected');
            });
            
            element.classList.add('selected');
            selectedAnswer = answer;
        }

        function moveToNextQuestion() {
            if (!isAdmin) return;
            
            const question = battleQuestions[currentQuestionIndex];
            
            // Show correct/wrong for all players
            showAnswerFeedback(question.correct);
            
            setTimeout(() => {
                currentQuestionIndex++;
                currentQuestionStartTime = 0;
                
                if (currentQuestionIndex >= battleQuestions.length) {
                    // Game ended
                    getRoomFromFirebase((room) => {
                        if (room) {
                            room.gameEnded = true;
                            // Sort and save final scores
                            room.players.sort((a, b) => b.score - a.score);
                            saveRoomToFirebase(room);
                        }
                    });
                } else {
                    // Move to next question
                    getRoomFromFirebase((room) => {
                        if (room) {
                            room.currentQuestion = currentQuestionIndex;
                            room.questionStartTime = Date.now();
                            currentQuestionStartTime = room.questionStartTime;
                            saveRoomToFirebase(room);
                        }
                    });
                }
            }, 2000);
        }

        function showAnswerFeedback(correctAnswer) {
            const question = battleQuestions[currentQuestionIndex];
            const isCorrect = selectedAnswer === correctAnswer;
            
            // Update score if correct
            if (isCorrect) {
                playerScore += question.weight;
                document.getElementById('playerScore').textContent = playerScore;
                
                // Update score in Firebase
                getRoomFromFirebase((room) => {
                    if (room) {
                        const playerIndex = room.players.findIndex(p => p.id === playerId);
                        if (playerIndex !== -1) {
                            room.players[playerIndex].score = playerScore;
                            saveRoomToFirebase(room);
                        }
                    }
                });
            }
            
            // Show correct/wrong visual feedback
            document.querySelectorAll('.answer-option').forEach((opt, idx) => {
                const optionLetter = ['A', 'B', 'C', 'D'][idx];
                if (optionLetter === correctAnswer) {
                    opt.classList.add('correct');
                } else if (optionLetter === selectedAnswer && !isCorrect) {
                    opt.classList.add('wrong');
                }
            });
        }

        function endBattle() {
            // Update player final score in Firebase
            getRoomFromFirebase((room) => {
                if (room) {
                    const playerIndex = room.players.findIndex(p => p.id === playerId);
                    if (playerIndex !== -1) {
                        room.players[playerIndex].score = playerScore;
                        room.players[playerIndex].finished = true;
                    }
                    saveRoomToFirebase(room);
                }
            });
        }

        function endBattleForAll() {
            clearInterval(questionTimerInterval);
            
            getRoomFromFirebase((room) => {
                if (room) {
                    // Get sorted players from Firebase
                    players = room.players.sort((a, b) => b.score - a.score);
                    
                    document.getElementById('battleGame').classList.add('hidden');
                    document.getElementById('battleResults').classList.remove('hidden');
                    
                    displayResults();
                }
            });
        }
                
 

        
        function listenToRoom() {
            if (roomListener) return; // Already listening
            
            const roomRef = window.firebaseRef(window.firebaseDB, 'rooms/' + roomCode);
            roomListener = window.firebaseOnValue(roomRef, (snapshot) => {
                if (snapshot.exists()) {
                    const room = snapshot.val();
                    players = room.players || [];
                    updatePlayerList();
                    
                    // Check if game started
                    if (room.gameStarted && !room.gameEnded) {
                        if (document.getElementById('battleWaiting').classList.contains('hidden') === false) {
                            // Game just started, load it
                            questionCount = room.questionCount || 10;
                            battleQuestions = room.questions || [];
                            startBattleForAll();
                        }
                    }
                    
                    // Check if game ended
                    if (room.gameEnded) {
                        if (!document.getElementById('battleResults').classList.contains('hidden') === false) {
                            endBattleForAll();
                        }
                    }
                }
            });
        }

        function endBattleForAll() {
            document.getElementById('battleGame').classList.add('hidden');
            document.getElementById('battleResults').classList.remove('hidden');
            
            displayResults();
        }

        function displayResults() {
            const podiumDiv = document.getElementById('podium');
            podiumDiv.innerHTML = '';
            
            // Display top 3
            const top3 = players.slice(0, 3);
            const positions = ['second', 'first', 'third'];
            const medals = ['🥈', '🥇', '🥉'];
            const ranks = ['2', '1', '3'];
            
            top3.forEach((player, index) => {
                const placeDiv = document.createElement('div');
                placeDiv.className = `podium-place ${positions[index]}`;
                placeDiv.innerHTML = `
                    <div class="podium-rank">${medals[index]}</div>
                    <div class="podium-name">${player.name}</div>
                    <div class="podium-score">${player.score} poin</div>
                `;
                podiumDiv.appendChild(placeDiv);
            });
            
            // Display full leaderboard
            const leaderboardDiv = document.getElementById('fullLeaderboard');
            leaderboardDiv.innerHTML = '';
            
            players.forEach((player, index) => {
                const itemDiv = document.createElement('div');
                itemDiv.className = 'leaderboard-item';
                itemDiv.innerHTML = `
                    <span><strong>#${index + 1}</strong> ${player.name}</span>
                    <span><strong>${player.score}</strong> poin</span>
                `;
                leaderboardDiv.appendChild(itemDiv);
            });
        }

        function resetRoom() {
            if (!isAdmin) {
                alert('Hanya admin yang bisa reset room!');
                return;
            }
            
            // Reset scores in Firebase
            getRoomFromFirebase((room) => {
                if (room) {
                    room.players.forEach(p => {
                        p.score = 0;
                        p.finished = false;
                    });
                    room.gameStarted = false;
                    room.gameEnded = false;
                    room.questions = [];
                    saveRoomToFirebase(room);
                    players = room.players;
                    
                    currentQuestionIndex = 0;
                    playerScore = 0;
                    
                    document.getElementById('battleResults').classList.add('hidden');
                    document.getElementById('battleWaiting').classList.remove('hidden');
                    document.getElementById('playerScore').textContent = '0';
                    
                    updatePlayerList();
                }
            });
        }

        function showBattleMenu() {
            document.getElementById('mainMenu').classList.add('hidden');
            document.getElementById('battleMenu').classList.remove('hidden');
            currentGame = 'battle';
        }

        // Original game functions
        function login() {
            const usernameInput = document.getElementById('usernameInput').value.trim();
            
            if (usernameInput === '') {
                alert('Ayo tulis nama kamu dulu! 😊');
                return;
            }
            
            username = usernameInput;
            document.getElementById('displayUsername').textContent = username;
            
            document.getElementById('loginScreen').classList.add('hidden');
            document.getElementById('mainMenu').classList.remove('hidden');
            document.getElementById('controlButtons').style.display = 'flex';
        }

        function startReading() {
            showGame('readingGame');
            currentGame = 'reading';
            loadReading();
        }

        function startMath() {
            showGame('mathGame');
            currentGame = 'math';
            setMathMode('hard');
        }

        function startGuessing() {
            showGame('guessGame');
            currentGame = 'guess';
            loadGuess();
        }

        function startSequence() {
            showGame('sequenceGame');
            currentGame = 'sequence';
            loadSequence();
        }

        function showGame(gameId) {
            document.getElementById('mainMenu').classList.add('hidden');
            document.querySelectorAll('.game-card').forEach(card => card.classList.add('hidden'));
            document.getElementById(gameId).classList.remove('hidden');
        }

        function loadReading() {
            const data = readingData[currentReadingIndex];
            document.getElementById('alphabetDisplay').textContent = data.letter;
            document.getElementById('alphabetLowercase').textContent = data.lowercase;
            document.getElementById('syllableDisplay').textContent = data.syllable;
            document.getElementById('readingExample').innerHTML = `Contoh: <strong>${data.example}</strong>`;
        }

        function setMathMode(mode) {
            mathMode = mode;
            
            const easyBtn = document.getElementById('easyModeBtn');
            const hardBtn = document.getElementById('hardModeBtn');
            
            if (mode === 'easy') {
                easyBtn.className = 'btn btn-warning me-2';
                hardBtn.className = 'btn btn-outline-danger';
            } else {
                easyBtn.className = 'btn btn-outline-warning me-2';
                hardBtn.className = 'btn btn-danger';
            }
            
            loadMath();
        }

        function loadMath() {
            const problem = mathProblems[Math.floor(Math.random() * mathProblems.length)];
            const mathProblemElement = document.getElementById('mathProblem');
            
            if (mathMode === 'easy') {
                mathProblemElement.textContent = problem.easyProblem;
                mathProblemElement.style.display = 'block';
            } else {
                mathProblemElement.style.display = 'none';
            }
            
            const visualContainer = document.getElementById('mathVisual');
            visualContainer.innerHTML = '';
            
            const visualData = mathMode === 'easy' ? problem.visual : problem.numbers;
            
            visualData.forEach(item => {
                const div = document.createElement('div');
                div.className = 'math-item';
                div.textContent = item;
                visualContainer.appendChild(div);
            });
            
            const equalDiv = document.createElement('div');
            equalDiv.className = 'math-item';
            equalDiv.textContent = '=';
            visualContainer.appendChild(equalDiv);
            
            const input = document.createElement('input');
            input.type = 'number';
            input.className = 'answer-input';
            input.id = 'mathAnswer';
            input.placeholder = '?';
            visualContainer.appendChild(input);
            
            currentMathAnswer = problem.answer;
            document.getElementById('mathResult').classList.add('hidden');
        }

        function loadGuess() {
            const problem = guessProblems[Math.floor(Math.random() * guessProblems.length)];
            document.getElementById('guessTarget').textContent = problem.target;
            currentGuessTarget = problem.target;
            
            const grid = document.getElementById('imageGrid');
            grid.innerHTML = '';
            selectedImages = [];
            
            const shuffled = [...problem.items].sort(() => Math.random() - 0.5);
            
            shuffled.forEach(item => {
                const div = document.createElement('div');
                div.className = 'image-item';
                div.textContent = item.text;
                div.dataset.correct = item.correct;
                div.onclick = () => selectImage(div);
                grid.appendChild(div);
            });
            
            document.getElementById('guessResult').classList.add('hidden');
        }

        function loadSequence() {
            const problem = sequenceProblems[Math.floor(Math.random() * sequenceProblems.length)];
            document.getElementById('sequenceQuestion').textContent = problem.question;
            document.getElementById('seqOptionA').textContent = problem.optionA;
            document.getElementById('seqOptionB').textContent = problem.optionB;
            correctSequence = problem.correct;
            
            document.querySelectorAll('#sequenceGame .btn').forEach(btn => {
                btn.className = 'btn btn-outline-primary btn-lg';
            });
            
            document.getElementById('sequenceResult').classList.add('hidden');
        }

        function selectImage(element) {
            element.classList.toggle('selected');
        }

        function selectSequence(button, option) {
            document.querySelectorAll('#sequenceGame .btn-outline-primary, #sequenceGame .btn-success, #sequenceGame .btn-danger').forEach(btn => {
                btn.className = 'btn btn-outline-primary btn-lg';
            });
            
            if (option === correctSequence) {
                button.className = 'btn btn-success btn-lg';
                showResult('sequenceResult', true, 'Benar! 🎉');
            } else {
                button.className = 'btn btn-danger btn-lg';
                showResult('sequenceResult', false, 'Coba lagi! 😊');
            }
        }

        function checkMathAnswer() {
            const userAnswer = parseInt(document.getElementById('mathAnswer').value);
            const isCorrect = userAnswer === currentMathAnswer;
            const message = isCorrect ? `Benar! Jawabannya ${currentMathAnswer} 🎉` : `Coba lagi! Jawabannya ${currentMathAnswer} 😊`;
            showResult('mathResult', isCorrect, message);
        }

        function checkGuessAnswer() {
            const selected = document.querySelectorAll('.image-item.selected');
            const correctItems = document.querySelectorAll('.image-item[data-correct="true"]');
            
            let isCorrect = selected.length === correctItems.length;
            if (isCorrect) {
                selected.forEach(item => {
                    if (item.dataset.correct !== 'true') {
                        isCorrect = false;
                    }
                });
            }
            
            const message = isCorrect ? 'Benar! 🎉' : 'Coba lagi! Pilih semua yang benar 😊';
            showResult('guessResult', isCorrect, message);
        }

        function showResult(elementId, isCorrect, message) {
            const element = document.getElementById(elementId);
            element.textContent = message;
            element.className = `result-message ${isCorrect ? 'correct' : 'incorrect'}`;
            element.classList.remove('hidden');
        }

        function randomizeQuestion() {
            switch(currentGame) {
                case 'reading':
                    currentReadingIndex = (currentReadingIndex + 1) % readingData.length;
                    loadReading();
                    break;
                case 'math':
                    loadMath();
                    break;
                case 'guess':
                    loadGuess();
                    break;
                case 'sequence':
                    loadSequence();
                    break;
            }
        }

        function goBack() {
            clearInterval(timerInterval);
            stopListeningToRoom();
            
            // Leave room if in battle
            if (roomCode) {
                getRoomFromFirebase((room) => {
                    if (room && !room.gameStarted) {
                        // Remove player from room
                        room.players = room.players.filter(p => p.id !== playerId);
                        
                        if (room.players.length === 0) {
                            // Delete room if empty
                            const roomRef = window.firebaseRef(window.firebaseDB, 'rooms/' + roomCode);
                            window.firebaseRemove(roomRef);
                        } else {
                            // If admin left, make first player new admin
                            if (isAdmin && room.players.length > 0) {
                                room.players[0].isAdmin = true;
                            }
                            saveRoomToFirebase(room);
                        }
                    }
                });
                roomCode = '';
            }
            
            document.querySelectorAll('.game-card').forEach(card => card.classList.add('hidden'));
            document.querySelectorAll('.menu-card').forEach(card => card.classList.add('hidden'));
            
            if (currentGame === 'battle') {
                document.getElementById('battleMenu').classList.remove('hidden');
            } else {
                document.getElementById('mainMenu').classList.remove('hidden');
            }
            
            currentGame = '';
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            document.getElementById('loginScreen').classList.remove('hidden');
            document.getElementById('mainMenu').classList.add('hidden');
            document.getElementById('controlButtons').style.display = 'none';
            
            document.getElementById('usernameInput').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    login();
                }
            });
        });
    </script>
</body>
</html>